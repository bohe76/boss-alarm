# 애플리케이션 공통 기능

## 1.1. 초기 로딩 및 화면 전환

**1. 개요**
애플리케이션은 사용자가 웹 페이지에 처음 접근할 때 초기 로딩 과정을 거쳐 대시보드 화면을 표시합니다. 이후 사용자는 좌측 사이드바 메뉴 또는 하단 내비게이션 바(모바일 환경)를 통해 다른 기능 화면으로 전환할 수 있습니다. 각 화면 전환 시 특정 로직과 사용자 피드백이 제공됩니다.

**2. 초기 로딩 경험**
*   **시각적 피드백:**
    *   애플리케이션 로딩 시작 시, 콘텐츠가 완전히 준비되기 전까지 대시보드 영역에 회색 블록으로 구성된 '스켈레톤 UI'가 잠시 표시됩니다. 이는 사용자에게 애플리케이션이 로딩 중임을 알리고 대기 시간을 덜 지루하게 만듭니다.
    *   모든 데이터 로딩 및 초기화가 완료되면, 스켈레톤 UI는 사라지고 실제 대시보드 콘텐츠가 부드럽게 나타납니다.
*   **초기 데이터 표시:**
    *   URL에 `?data=...` 파라미터가 포함되어 있으면, 해당 파라미터의 보스 목록 데이터를 자동으로 로드하여 적용하고 대시보드에 표시합니다.
    *   URL 파라미터가 없거나 유효하지 않은 경우, 미리 정의된 기본 보스 목록이 로드되어 대시보드에 표시됩니다.
    *   유효하지 않은 URL 데이터가 감지되면, 사용자에게 경고 메시지("URL의 보스 설정 값이 올바르지 않습니다...")가 표시된 후 기본 보스 목록으로 대체됩니다.
*   **알람 상태 복원:** 로컬 스토리지에 저장된 이전 알람 실행 상태에 따라 알람 시스템이 자동으로 시작되거나 중지된 상태로 유지됩니다. 알람 버튼(헤더 우측 상단)의 아이콘이 이에 맞춰 업데이트됩니다.
*   **사이드바 상태 복원:** 로컬 스토리지에 저장된 설정에 따라 사이드바가 확장된 상태이거나 접힌 상태로 표시됩니다.
*   **최초 화면:** 초기 로딩 완료 후 '대시보드' 화면이 자동으로 활성화되어 사용자에게 표시됩니다.

**3. 화면 전환 경험**
*   **전환 방법:**
    *   **메뉴 클릭:** 좌측 사이드바 메뉴 항목(`대시보드`, `보스 설정` 등) 또는 모바일 환경의 하단 내비게이션 바 항목 클릭 시 해당 화면으로 전환됩니다.
    *   **시스템 전환:** 특정 기능 수행 후 시스템이 자동으로 다른 화면으로 전환을 요청할 수 있습니다 (예: '보스 스케줄러'에서 "보스 설정 적용" 버튼 클릭 후 '보스 관리' 화면으로 이동).
*   **사용자 피드백 및 조건:**
    *   **스크롤 초기화:** 모든 화면 전환 시, 새로 활성화되는 화면의 콘텐츠는 최상단에서부터 표시되도록 스크롤 위치가 자동으로 초기화됩니다.
    *   **내비게이션 활성화 표시:** 현재 활성화된 화면에 해당하는 메뉴 항목(사이드바 및 하단 내비게이션)은 시각적으로 '활성(active)' 상태로 표시됩니다.
    *   **미저장 변경 경고 (보스 설정 화면):**
        *   '보스 설정' 화면(`boss-management-screen`)에서 텍스트 영역의 내용을 수정하고 "보스 설정 저장" 버튼을 누르지 않은 상태에서 다른 화면으로 이동하려고 하면, "값이 저장되지 않았습니다. 그래도 화면을 이동하시겠습니까?"라는 경고 메시지(`confirm` 대화상자)가 표시됩니다.
        *   사용자가 '취소'를 선택하면 화면 전환은 이루어지지 않으며, '확인'을 선택하면 화면이 전환되지만 '보스 설정' 화면의 수정된 내용은 저장되지 않고 이전 상태로 되돌려집니다.
    *   **대시보드 실시간 갱신:** '대시보드' 화면이 활성화된 동안에는 1초마다 다음 보스 정보, 다가오는 보스 목록 등이 실시간으로 갱신됩니다. 다른 화면으로 전환하면 이 실시간 갱신은 자동으로 중지됩니다.
    *   **모바일 메뉴 동작:**
        *   모바일 환경에서는 좌측 상단의 '사이드바 토글' 버튼 또는 하단 내비게이션 바의 '더보기' 버튼을 눌러 전체 메뉴를 오버레이 형태로 열고 닫을 수 있습니다.
        *   메뉴가 열린 상태에서 아무 메뉴 항목을 클릭하면 해당 화면으로 이동하면서 메뉴는 자동으로 닫힙니다.
        *   'Esc' 키를 누르거나, 메뉴 외부 영역을 클릭하면 메뉴가 닫힙니다.
        *   메뉴가 열리면 주 콘텐츠 영역은 비활성화(inert)되어 메뉴에만 포커스가 가도록 합니다.

---

## 1.2. 전역 알림 시스템 (음성 및 시각적 알림)

**1. 개요**
애플리케이션은 사용자에게 보스 출현 시간을 정확히 알리기 위한 전역 알림 시스템을 제공합니다. 이 시스템은 동적 보스 목록과 사용자가 설정한 고정 알림을 모두 관리하며, 보스 출현 5분 전, 1분 전, 그리고 정각에 음성 및 시각적 알림을 발생시킵니다. 알림 상태는 사용자가 제어할 수 있으며, 음소거 설정도 가능합니다.

**2. 알림 시스템 활성화/비활성화**
*   **제어:** 헤더 우측 상단에 위치한 '알람 토글 버튼'(`alarmToggleButton`)을 클릭하여 알림 시스템을 시작하거나 중지할 수 있습니다.
*   **시각적 피드백:**
    *   알림 시스템 시작 시, 버튼의 아이콘이 변경되고 시각적으로 '활성' 상태임을 나타냅니다.
    *   알림 시스템 중지 시, 버튼의 아이콘이 변경되고 시각적으로 '비활성' 상태임을 나타냅니다.
*   **음성 및 로그 알림:**
    *   시스템 시작 시: "보스 알리미를 시작합니다." 음성 메시지와 함께 로그에 기록됩니다. 현재 활성화된 보스 목록의 보스 개수가 함께 안내됩니다.
    *   시스템 중지 시: "알리미를 중지합니다." 음성 메시지와 함께 로그에 기록됩니다.
*   **상태 유지:** 알림 시스템의 실행 상태는 웹 브라우저의 로컬 스토리지에 저장되어, 애플리케이션을 재시작해도 마지막 상태가 복원됩니다.

**3. 알림 발생 조건 및 유형**
*   **대상:**
    *   사용자가 '보스 설정' 화면에서 입력하고 저장한 동적 보스 목록.
    *   '설정' 화면의 '고정 알림' 목록에서 '활성화'된 알림.
*   **주기:** 알림 시스템 활성화 시, **Web Worker**를 통해 매초마다 현재 시간과 등록된 보스/알림의 출현 시간을 정밀하게 비교하여 알림 조건을 확인합니다. 이는 브라우저가 백그라운드(최소화, 다른 탭 사용 중)에 있어도 타이머가 멈추지 않고 정확한 시간에 동작함을 보장합니다.
*   **알림 시점:**
    *   **5분 전:** 보스 출현 시간 5분 전.
    *   **1분 전:** 보스 출현 시간 1분 전.
    *   **정각 (0분):** 보스 출현 시간.
*   **알림 내용:**
    *   **음성 알림:** `window.speechSynthesis` API를 사용하여 "5분 전, [보스 이름]", "1분 전, [보스 이름]", "[보스 이름] 젠 입니다." 와 같은 음성 메시지를 출력합니다.
    *   **시각적 알림 (로그):** '대시보드'의 '최근 알림 로그' 섹션 및 '로그' 화면에 "[시간] [메시지]" 형식으로 알림 메시지가 실시간으로 기록됩니다. 중요한 알림은 로그에서 시각적으로 강조됩니다.
    *   **시스템 알림 (OS 배너):** 브라우저가 백그라운드 상태일 때도 사용자가 알림을 놓치지 않도록 OS 시스템 알림(Notification API)을 띄웁니다. 알림 배너를 클릭하면 브라우저 창이 활성화됩니다.
*   **중복 알림 방지:** 한 번 발생한 특정 시점(5분 전, 1분 전, 정각)의 알림은 다시 발생하지 않습니다.
*   **알림 제거 (동적 보스):** 정각 알림이 발생한 동적 보스는 보스 목록에서 자동으로 제거되어 더 이상 알림이 발생하지 않습니다. (고정 알림은 제거되지 않음).

**4. 음소거 기능**
*   **제어:** '대시보드'의 '소리 설정' 카드에 위치한 '음소거 토글 버튼'(`muteToggleButton`)을 클릭하여 음성 알림을 음소거하거나 해제할 수 있습니다.
*   **시각적 피드백:** 버튼의 아이콘이 음소거 상태에 따라 변경됩니다.
*   **음성 알림 제한:** 음소거 상태에서는 모든 음성 알림이 발생하지 않습니다.
*   **상태 유지:** 음소거 상태는 로컬 스토리지에 저장되어, 애플리케이션을 재시작해도 마지막 상태가 복원됩니다.

**5. 일간 반복 (`자정 초기화`)**
*   매일 자정(00:00)이 되면, 모든 보스/알림의 알림 상태(5분 전, 1분 전, 정각 알림 여부)가 자동으로 초기화됩니다. 이는 매일 동일한 보스에 대해 알림이 반복적으로 발생할 수 있도록 합니다.

---

## 1.3. Local Storage를 통한 설정 및 데이터 저장

**1. 개요**
애플리케이션은 사용자의 설정 및 특정 데이터를 웹 브라우저의 로컬 스토리지(`localStorage`)에 영구적으로 저장하고 관리합니다. 이를 통해 사용자는 애플리케이션을 닫았다 다시 열어도 개인화된 환경과 데이터가 유지되는 경험을 할 수 있습니다. 모든 로컬 스토리지 관련 작업은 `LocalStorageManager` 모듈을 통해 중앙에서 관리됩니다.

**2. 저장되는 설정 및 데이터 항목**

*   **고정 알림 (Fixed Alarms):**
    *   사용자가 '설정' 화면에서 추가, 편집, 삭제, 활성화/비활성화한 모든 고정 알림 목록이 저장됩니다.
    *   각 알림은 고유 ID, 이름, 시간, 활성화 여부 등의 정보를 포함합니다.
    *   외부로 내보내기/가져오기 기능(`exportFixedAlarms`, `importFixedAlarms`)을 통해 Base64 인코딩된 문자열 형태로 공유 및 백업이 가능합니다.
*   **알림 실행 상태 (Alarm Running State):**
    *   알림 시스템이 현재 '시작됨'(`true`)인지 '중지됨'(`false`)인지의 상태가 저장됩니다.
    *   애플리케이션 재시작 시 마지막 상태가 복원되어, 수동으로 다시 시작할 필요 없이 알림 시스템이 이전처럼 작동합니다.
*   **음소거 상태 (Mute State):**
    *   음성 알림이 '음소거됨'(`true`)인지 '음소거 해제됨'(`false`)인지의 상태가 저장됩니다.
    *   애플리케이션 재시작 시 마지막 상태가 복원됩니다.
*   **사이드바 확장 상태 (Sidebar Expanded State):**
    *   사이드바 메뉴가 '확장됨'(`true`)인지 '접힘'(`false`)인지의 상태가 저장됩니다.
    *   애플리케이션 재시작 시 마지막 상태가 복원되어, 사용자에게 일관된 UI 경험을 제공합니다.
*   **로그 가시성 상태 (Log Visibility State):**
    *   '로그' 화면에서 '15개 보기' 토글 버튼의 '활성화'(`true`) 또는 '비활성화'(`false`, 전체 보기) 상태가 저장됩니다.
    *   애플리케이션 재시작 시 마지막 상태가 복원됩니다.
*   **광 계산기 기록 (Light Calculator Records):**
    *   사용자가 '보탐 계산기'의 '광 계산기'에서 "잡힘" 버튼을 눌러 저장한 모든 계산 기록이 저장됩니다.
    *   각 기록은 ID, 보스 이름, 광 시간, 잡힘 후 시간, 총 시간, 타임스탬프 등의 정보를 포함합니다.

**3. 데이터 관리 방식**
*   **중앙 관리:** 모든 로컬 스토리지 접근은 `LocalStorageManager` 모듈 내의 전용 getter/setter 함수(예: `getFixedAlarms()`, `setMuteState(state)`)를 통해서만 이루어집니다.
*   **초기 로드:** 애플리케이션 시작 시 `LocalStorageManager.init()` 함수가 호출되어 로컬 스토리지에 저장된 모든 항목을 읽어와 애플리케이션 메모리 상태를 초기화합니다.
*   **자동 저장:** 관련 설정이나 데이터가 변경될 때마다 해당 getter/setter 함수 내부에서 자동으로 로컬 스토리지에 저장됩니다. (예: `setMuteState(state)` 호출 시 `muteState` 변수 업데이트 및 `localStorage`에 저장).
*   **데이터 타입:** 모든 데이터는 JSON.stringify()를 통해 문자열로 변환되어 저장되며, 로드 시 JSON.parse()를 통해 원래 데이터 타입으로 복원됩니다.

**4. 데이터 마이그레이션 (고정 알림)**
*   기존에 다른 형식으로 저장되어 있던 '고정 알림' 데이터(`fixedAlarmStates` 키)가 있을 경우, `LocalStorageManager.init()` 과정에서 자동으로 새로운 형식으로 변환하여 저장합니다. 변환 후에는 이전 키를 로컬 스토리지에서 삭제합니다.

---

## 1.4. TinyURL을 통한 URL 단축 및 공유

**1. 개요**
애플리케이션은 현재 설정된 동적 보스 목록을 URL 파라미터(`?data=...`)로 인코딩하여 다른 사용자와 쉽게 공유할 수 있도록 TinyURL 서비스를 통해 짧은 URL을 생성하는 기능을 제공합니다. 생성된 짧은 URL은 사용자의 클립보드에 자동으로 복사되며, 관련 메시지가 화면에 표시됩니다. 이 기능은 '공유' 화면에서 접근할 수 있습니다.

**2. 기능 접근**
*   사용자는 좌측 사이드바 메뉴 또는 하단 내비게이션 바(모바일 환경)에서 '공유' 메뉴 항목을 클릭하여 '공유' 화면으로 이동합니다.

**3. 짧은 URL 생성 과정**
*   **자동 생성:** '공유' 화면으로 이동하는 순간, 별도의 사용자 입력 없이 자동으로 짧은 URL 생성 과정이 시작됩니다.
*   **원본 URL 구성:**
    1.  현재 애플리케이션에 활성화되어 있는 동적 보스 목록(`BossDataManager`에 저장된 `bossSchedule` 데이터 중 'boss' 타입 항목들)을 텍스트 형태로 추출합니다.
    2.  이 텍스트 데이터는 URL로 안전하게 전달될 수 있도록 `encodeURIComponent()` 함수를 사용하여 인코딩됩니다.
    3.  인코딩된 데이터는 현재 페이지 URL에 `?data=` 파라미터로 추가되어 긴 URL을 구성합니다 (예: `https://example.com/?data=인코딩된보스목록`).
*   **TinyURL API 호출:** 구성된 긴 URL은 `src/api-service.js`의 `getShortUrl()` 함수를 통해 TinyURL 서비스의 API로 전송됩니다.
*   **짧은 URL 반환:** TinyURL API로부터 단축된 URL이 반환됩니다.

**4. 사용자 피드백 및 동작**
*   **클립보드 복사:** 생성된 짧은 URL은 자동으로 사용자의 클립보드에 복사됩니다.
*   **화면 메시지:** '공유' 화면 내 `shareMessage` 영역에 생성된 짧은 URL과 함께 "클립보드에 복사되었습니다!"와 같은 성공 메시지가 표시됩니다.
*   **오류 처리:**
    *   TinyURL API 호출에 실패하거나 네트워크 오류가 발생할 경우, 사용자에게 오류 메시지가 표시됩니다 (예: "URL 단축에 실패했습니다.").
    *   로그에도 해당 오류 내용이 기록됩니다.
*   **공유 대상:** 이 기능은 오직 '동적 보스 목록'만 공유하며, 사용자가 '설정' 화면에서 추가한 '고정 알림' 목록은 공유되지 않습니다.

---

## 1.5. EventBus를 통한 모듈 간 통신

**1. 개요**
애플리케이션은 `EventBus`라는 간단한 전역 이벤트 시스템을 통해 각 모듈이 서로 직접적인 의존성 없이 메시지를 주고받을 수 있도록 합니다. 이는 모듈 간의 결합도를 낮추고 유연한 확장을 가능하게 하는 디자인 패턴입니다. 사용자는 `EventBus`를 직접적으로 조작하지 않지만, `EventBus`를 통해 전달되는 이벤트들은 애플리케이션의 동작과 사용자 경험에 영향을 미칩니다.

**2. 주요 역할**
*   **느슨한 결합:** 모듈들이 특정 모듈의 존재를 알 필요 없이 이벤트를 발행하거나 구독할 수 있도록 하여, 시스템의 유연성과 유지보수성을 높입니다.
*   **중앙 집중식 통신 채널:** 모든 모듈 간의 비동기적 통신이 `EventBus`를 통해 이루어지므로, 데이터 흐름을 추적하고 디버깅하는 데 용이합니다.

**3. EventBus 사용 사례 (사용자 경험에 미치는 영향)**

*   **화면 전환 (`navigate` 이벤트):**
    *   **발행자:** `app.js`의 `showScreen` 함수가 `EventBus.emit('navigate', screenId)`를 호출하여 다른 화면으로 전환을 요청합니다. (예: '보스 스케줄러' 화면에서 "보스 설정 적용" 후 '보스 관리' 화면으로 자동 이동).
    *   **구독자:** `app.js`는 `EventBus.on('navigate', ...)`를 구독하여 요청된 `screenId`에 해당하는 화면으로 실제 UI를 전환합니다.
    *   **사용자 영향:** 특정 사용자 액션(예: 버튼 클릭) 또는 시스템 로직에 따라 화면이 자동으로 변경됩니다.

*   **로그 업데이트 (`log-updated` 이벤트):**
    *   **발행자:** `src/logger.js`의 `log()` 함수가 새로운 로그 메시지가 추가될 때마다 `EventBus.emit('log-updated')`를 호출합니다.
    *   **구독자:**
        *   '대시보드' 화면은 `log-updated` 이벤트를 구독하여 '최근 알림 로그' 섹션을 실시간으로 갱신합니다.
        *   '로그' 화면은 `log-updated` 이벤트를 구독하여 전체 로그 목록을 실시간으로 갱신합니다.
    *   **사용자 영향:** 알림 발생 등 시스템에서 중요한 이벤트가 발생할 때마다 '대시보드'와 '로그' 화면에 최신 로그 메시지가 자동으로 표시됩니다.

*   **보스 스케줄러 갱신 (`rerender-boss-scheduler` 이벤트):**
    *   **발행자:** '개인 보스 목록' 모달에서 커스텀 보스 목록이 추가, 수정, 삭제될 때 `EventBus.emit('rerender-boss-scheduler')`를 호출합니다.
    *   **구독자:** '보스 스케줄러' 화면은 이 이벤트를 구독하여 게임 선택 드롭다운 목록을 갱신합니다.
    *   **사용자 영향:** 커스텀 보스 목록을 변경하면 '보스 스케줄러' 화면의 게임 선택 드롭다운에 변경된 내용이 즉시 반영되어, 사용자가 새로운 커스텀 목록을 선택할 수 있게 됩니다.

**4. 이벤트 전달 데이터:**
*   `emit` 함수는 이벤트와 함께 데이터를 전달할 수 있습니다. 예를 들어 `navigate` 이벤트는 전환할 화면의 `screenId`를 데이터로 전달합니다.