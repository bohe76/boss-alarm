<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë³´ìŠ¤ ì•Œë¦¬ë¯¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
                Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
            background-color: #f4f7f6;
            color: #333;
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #111;
        }
        textarea {
            width: 95%;
            height: 250px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .next-boss-highlight {
            color: #d90007; /* Red color */
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button {
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 95%;
            margin-bottom: 10px;
        }
        
        /* ì•Œë¦¼ ì‹œì‘/ì¤‘ì§€ ë²„íŠ¼ */
        #startButton { background-color: #007aff; color: white; }
        #startButton:hover { background-color: #0056b3; }
        #startButton.running { background-color: #d90007; }
        #startButton.running:hover { background-color: #b30006; }

        /* ê³µìœ  ë§í¬ ìƒì„± ë²„íŠ¼ */
        #shareButton { background-color: #34c759; color: white; }
        #shareButton:hover { background-color: #2a9e48; }
        #shareButton:disabled { background-color: #aaa; cursor: not-allowed; }
        
        /* ë§í¬ ì…ë ¥ì°½ + ë³µì‚¬ ë²„íŠ¼ ê·¸ë£¹ */
        .input-group {
            display: flex;
            width: 95%;
            align-items: center;
        }
        
        /* ë§í¬ í‘œì‹œì°½ */
        #shareLinkInput {
            flex-grow: 1; /* ë‚¨ëŠ” ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 8px 0 0 8px; /* ì™¼ìª½ ëª¨ì„œë¦¬ */
            background-color: #eee;
            margin: 0;
            /* input íƒœê·¸ì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
            border-right: none;
        }
        
        /* ë³µì‚¬ ë²„íŠ¼ */
        #copyButton {
            width: auto; /* ë‚´ìš©ì— ë§ê²Œ ë„ˆë¹„ ì¡°ì ˆ */
            padding: 10px 15px;
            font-size: 14px;
            margin: 0;
            border-radius: 0 8px 8px 0; /* ì˜¤ë¥¸ìª½ ëª¨ì„œë¦¬ */
            background-color: #6c757d;
            color: white;
        }
        #copyButton:hover {
            background-color: #5a6268;
        }

        /* ì•Œë¦¼ ë¡œê·¸ ì°½ */
        #log-container {
            margin-top: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
        }
        .log-entry { 
            padding: 5px 0; 
            border-bottom: 1px dashed #eee; 
        }
        .log-entry.important { 
            font-weight: bold; 
            color: #d90007; 
        }
        footer {
            margin-top: 50px; /* Increased margin for better separation */
            padding: 20px 0; /* Add some padding */
            text-align: center;
            font-size: 0.9em; /* Slightly larger font */
            color: white; /* Text color to white */
            border-top: 1px solid #eee; /* Subtle top border */
            background-color: #333; /* Dark background color */
            width: 100%; /* Make it full width */
            margin-left: 0; /* Remove left margin */
            margin-right: 0; /* Remove right margin */
            box-sizing: border-box; /* Include padding in width calculation */
        }

        /* Switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 23px;
            margin-left: 10px;
            vertical-align: middle;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .1s; /* Changed from .2s */
            transition: .1s;        /* Changed from .2s */
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 15px;
            width: 15px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #007aff;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #007aff;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(17px);
            -ms-transform: translateX(17px);
            transform: translateX(17px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 23px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Fixed alarm section styles */
        .fixed-alarm-section {
            margin-bottom: 20px;
        }

        .fixed-alarm-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .fixed-alarm-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }

        .fixed-alarm-item:last-child {
            border-bottom: none;
        }

        .fixed-alarm-item.faded {
            opacity: 0.5;
            transition: opacity 0.3s ease-in-out;
        }

        .log-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .hidden {
            display: none !important; /* Use !important to ensure it overrides other display properties */
        }
    </style>
</head>
<body>

    <h1>ğŸ™ï¸ ë³´ìŠ¤ ì•Œë¦¬ë¯¸</h1>
    <br>
    
    <button id="startButton">ì•Œë¦¼ ì‹œì‘</button>

    <p>
        ë“£ê³  ì‹¶ì§€ ì•Šì€ ë³´ìŠ¤ëŠ” ì•Œë¦¼ ì¤‘ì§€ í›„, í…ìŠ¤íŠ¸ì—ì„œ ì‚­ì œí•˜ê³ , ë‹¤ì‹œ ì•Œë¦¼ì„ í™œì„±í™” í•´ì£¼ì„¸ìš”.
    </p>

    <h3>í•„ë“œ ë³´ìŠ¤</h3>
    <div id="nextBossDisplay" class="next-boss-highlight"></div>
    <textarea id="bossListInput">
11:00 ì…€ë¡œë¹„ì•„
11:00 ë‹ˆë“œí˜¸ê·¸
11:01 ë¼íƒ€í† ìŠ¤í¬
11:02 ì§€ê°4ì¸µ
11:13 ì§€ê°7ì¸µ
11:17 í—¤ë¥´ëª¨ë“œ
11:22 í˜í‹°
11:25 ìˆ˜ë“œë¦¬
11:27 ìƒ¤ë¬´í¬
11:30 í† ë¥´
11:33 ë¹„ìš”ë¥¸
11:40 ë“œë¼ìš°ê·¸
11:46 ëª¨ë„¤ê°€ë¦„
11:52 ìŠ¤ì¹¼ë¼ë‹ˆë¥´
12:09 ì§€ê°10ì¸µ
13:06 íŒŒë¥´ë°”
13:07 ë¸Œë¥€íë“œ
13:13 ë°”ìš°í‹°
13:17 ìˆ˜ë¥´íŠ¸
13:51 ë¼ì´ë…¸ë¥´
14:18 í‹°ë¥´
14:39 ì•¼ë¥¸
14:53 ì—˜ë“œë£¬
14:59 ìŠ¤ë°”ë¥´íŠ¸
16:35 íë‹ˆë¥´
16:36 ë©”ê¸°ë¥´
17:39 ìŠ¤ì¹¼ë“œë©”ë¥´
19:34 ì‹ ë§ˆë¼
19:42 ìš°ë¡œë³´ë¡œìŠ¤
20:08 íƒ•ê·¸ë¦¬ìŠ¤ë‹ˆë¥´
20:13 ë‘ë¼ìŠ¤ë¡œë¥´
20:13 í—¤ë¥´ê°€ë¦„
20:59 êµ´ë² ì´ê·¸
21:43 í™”ì‹ ê·¸ë¡œì•„
22:01 ì˜¤ë”˜
23:00 ì…€ë¡œë¹„ì•„
23:00 ë‹ˆë“œí˜¸ê·¸
23:01 ë¼íƒ€í† ìŠ¤í¬
23:02 ì§€ê°4ì¸µ
23:17 í—¤ë¥´ëª¨ë“œ
23:22 í˜í‹°
23:25 ìˆ˜ë“œë¦¬
23:29 ë…¸íŠ¸
23:33 ë¹„ìš”ë¥¸
23:52 ìŠ¤ì¹¼ë¼ë‹ˆë¥´
01:06 íŒŒë¥´ë°”
01:07 ë¸Œë¥€íë“œ
01:13 ë°”ìš°í‹°
01:51 ë¼ì´ë…¸ë¥´
02:39 ì•¼ë¥¸
03:50 ë¯¸ë¯¸ë¥´
04:35 íë‹ˆë¥´
05:50 ë°œë¦¬
    </textarea>
    <br>
    <div class="fixed-alarm-section">
        <div class="fixed-alarm-header">
            <h3>ê³ ì • ì•Œë¦¼</h3>
            <label class="switch">
                <input type="checkbox" id="globalFixedAlarmToggle">
                <span class="slider round"></span>
            </label>
        </div>
        <div id="fixedAlarmList">
            <!-- Fixed alarms will be rendered here by JavaScript -->
        </div>
    </div>
    <br>
    <h3>ê³µìœ í•˜ê¸°</h3>
    
    <button id="shareButton">ê³µìœ  ë§í¬ ìƒì„± (Short URL)</button>
    
    <div class="input-group">
        <input type="text" id="shareLinkInput" value="ëª©ë¡ ìˆ˜ì • í›„ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”" readonly>
        <button id="copyButton">ë³µì‚¬</button>
    </div>

    <div class="log-header">
        <h3>ì•Œë¦¼ ë¡œê·¸</h3>
        <label class="switch">
            <input type="checkbox" id="logVisibilityToggle">
            <span class="slider round"></span>
        </label>
    </div>
    
    <div id="log-container"></div>

    <script>
        // --- 1. DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const bossListInput = document.getElementById('bossListInput');
        const startButton = document.getElementById('startButton');
        const logContainer = document.getElementById('log-container');
        const shareButton = document.getElementById('shareButton');
        const shareLinkInput = document.getElementById('shareLinkInput');
        const copyButton = document.getElementById('copyButton');
        const nextBossDisplay = document.getElementById('nextBossDisplay');
        const globalFixedAlarmToggle = document.getElementById('globalFixedAlarmToggle');
        // const fixedAlarmListDiv = document.getElementById('fixedAlarmList'); // í˜ì´ì§€ ë¡œë“œ ì‹œì ì— ê°€ì ¸ì˜¤ë„ë¡ ë³€ê²½
        const logVisibilityToggle = document.getElementById('logVisibilityToggle');

        // --- 2. ì „ì—­ ë³€ìˆ˜ ì„¤ì • ---
        // ì›¹í˜ì´ì§€ ì „ì²´ì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ë“¤ì„ ë¯¸ë¦¬ ì„ ì–¸í•©ë‹ˆë‹¤.
        let bossSchedule = []; // íŒŒì‹±ëœ ë³´ìŠ¤ ì •ë³´ë¥¼ ì €ì¥í•  ë°°ì—´
        let fixedBossSchedule = [ // ê³ ì • ì•Œë¦¼ ë³´ìŠ¤ ëª©ë¡ (í•˜ë“œì½”ë”©)
            { time: "12:00", name: "ëŒ€ë¥™ ì¹¨ëµì", alerted_5min: false, alerted_1min: false, alerted_0min: false },
            { time: "20:00", name: "ëŒ€ë¥™ ì¹¨ëµì", alerted_5min: false, alerted_1min: false, alerted_0min: false },
            { time: "13:00", name: "ë°œí• ë¼", alerted_5min: false, alerted_1min: false, alerted_0min: false },
            { time: "18:00", name: "ë°œí• ë¼", alerted_5min: false, alerted_1min: false, alerted_0min: false },
            { time: "21:00", name: "ë°œí• ë¼", alerted_5min: false, alerted_1min: false, alerted_0min: false },
        ];
        let fixedAlarmStates = { // ê³ ì • ì•Œë¦¼ ìŠ¤ìœ„ì¹˜ ìƒíƒœ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ìš©)
            global: false, // ê³ ì • ì•Œë¦¼ ì „ì²´ ON/OFF
            individual: fixedBossSchedule.map(() => false) // ê° ê³ ì • ì•Œë¦¼ ê°œë³„ ON/OFF
        };
        let alertTimerId = null; // 1ì´ˆë§ˆë‹¤ ì•ŒëŒì„ ì²´í¬í•˜ëŠ” íƒ€ì´ë¨¸ì˜ ID (ë‚˜ì¤‘ì— ì¤‘ì§€ì‹œí‚¬ ë•Œ í•„ìš”)
        let isAlarmRunning = false; // ì•ŒëŒì´ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ì§€ ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜ (í† ê¸€ìš©)

        // --- 2.1. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ í•¨ìˆ˜ ---
        function saveFixedAlarmStates() {
            localStorage.setItem('fixedAlarmStates', JSON.stringify(fixedAlarmStates));
        }

        function loadFixedAlarmStates() {
            const savedStates = localStorage.getItem('fixedAlarmStates');
            if (savedStates) {
                fixedAlarmStates = JSON.parse(savedStates);
            } else {
                // ê¸°ë³¸ê°’: ëª¨ë‘ OFF
                fixedAlarmStates = {
                    global: false,
                    individual: fixedBossSchedule.map(() => false)
                };
                saveFixedAlarmStates();
            }
        }

        let logVisibilityState = true; // ê¸°ë³¸ê°’: ON

        function saveLogVisibilityState() {
            localStorage.setItem('logVisibilityState', JSON.stringify(logVisibilityState));
        }

        function loadLogVisibilityState() {
            const savedState = localStorage.getItem('logVisibilityState');
            if (savedState !== null) { // Check for null to distinguish from 'false'
                logVisibilityState = JSON.parse(savedState);
            } else {
                // ê¸°ë³¸ê°’: ON
                logVisibilityState = true;
                saveLogVisibilityState();
            }
        }


        // --- 3. ìŒì„± ì¬ìƒ í•¨ìˆ˜ ---
        // í…ìŠ¤íŠ¸ë¥¼ ë°›ì•„ì„œ AI ìŒì„±ìœ¼ë¡œ ì½ì–´ì£¼ëŠ” ê¸°ëŠ¥ì„ í•©ë‹ˆë‹¤.
        function speak(text) {
            // ë¸Œë¼ìš°ì €ê°€ ìŒì„± ì¶œë ¥(TTS) ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë©´ í•¨ìˆ˜ë¥¼ ì¦‰ì‹œ ì¢…ë£Œ
            if (!window.speechSynthesis) {
                console.warn("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            
            // í˜¹ì‹œ ì´ì „ì— ì¬ìƒ ì¤‘ì¸ ìŒì„±ì´ ìˆë‹¤ë©´ ì¦‰ì‹œ ì·¨ì†Œ (ì¤‘ë³µ ì¬ìƒ ë°©ì§€)
            window.speechSynthesis.cancel();
            
            // ì½ì–´ì¤„ ë‚´ìš©(text)ìœ¼ë¡œ ìŒì„± ê°ì²´(utterance)ë¥¼ ìƒì„±
            const utterance = new SpeechSynthesisUtterance(text);
            
            // ì–¸ì–´ë¥¼ í•œêµ­ì–´ë¡œ ì„¤ì •
            utterance.lang = 'ko-KR';
            
            // ìŒì„± ì¬ìƒ ì‹œì‘
            window.speechSynthesis.speak(utterance);
        }


        // --- 4. ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜ ---
        // í˜ì´ì§€ í•˜ë‹¨ì˜ ë¡œê·¸ ì°½ì— ë©”ì‹œì§€ë¥¼ ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥ì„ í•©ë‹ˆë‹¤.
        function log(message, isImportant = false) {
            // ìƒˆë¡œìš´ div ìš”ì†Œë¥¼ ìƒì„±
            const entry = document.createElement('div');
            entry.className = 'log-entry'; // ê¸°ë³¸ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì ìš©
            
            // isImportantê°€ trueì´ë©´, 'important' í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•´ ê¸€ì”¨ë¥¼ ê°•ì¡°
            if (isImportant) {
                entry.classList.add('important');
            }
            
            // í˜„ì¬ ì‹œê°„ì„ ê°€ì ¸ì™€ì„œ ë©”ì‹œì§€ ì•ì— ë¶™ì—¬ì¤Œ (ì˜ˆ: [11:17:30])
            const now = new Date();
            entry.textContent = `[${now.toLocaleTimeString()}] ${message}`;
            
            // ì™„ì„±ëœ ë¡œê·¸ ë©”ì‹œì§€ë¥¼ ë¡œê·¸ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            logContainer.appendChild(entry);
            
            // í•­ìƒ ìµœì‹  ë¡œê·¸ê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™
            logContainer.scrollTop = logContainer.scrollHeight;
        }


        // --- 5. í…ìŠ¤íŠ¸ íŒŒì‹± í•¨ìˆ˜ ---
        // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í…ìŠ¤íŠ¸ ìƒìì˜ ë‚´ìš©ì„ ì½ì–´ bossSchedule ë°°ì—´ í˜•íƒœë¡œ ê°€ê³µí•©ë‹ˆë‹¤.
        function parseBossList() {
            const text = bossListInput.value;
            const now = new Date();
            let currentDayOffset = 0; // 0 for today, 1 for tomorrow, etc.
            let lastBossTimeInMinutes = -1; // To track if time goes backward (indicating next day)

            let initialBossCount = 0;
            let removedPastBossCount = 0;
            
            const newBossSchedule = [];

            text.split(/\r?\n/)
                .map(line => line.trim())
                .filter(line => line)
                .forEach(line => {
                    const parts = line.split(/\s+/);
                    if (parts.length >= 2) {
                        initialBossCount++;
                        const [bossHour, bossMinute] = parts[0].split(':').map(Number);
                        const bossTimeInMinutes = bossHour * 60 + bossMinute;

                        // Check for day transition (e.g., 23:00 then 01:00)
                        if (bossTimeInMinutes < lastBossTimeInMinutes) {
                            currentDayOffset++;
                        }
                        lastBossTimeInMinutes = bossTimeInMinutes;

                        let scheduledDate = new Date(now);
                        scheduledDate.setHours(bossHour, bossMinute, 0, 0);

                        // If the boss's scheduled time (HH:MM) is earlier than the current time (HH:MM)
                        // AND it's not already for a future day due to currentDayOffset,
                        // then this boss must be for the next day.
                        // This handles cases like current time 00:30, boss time 23:00 (should be tomorrow).
                        if (scheduledDate.getTime() < now.getTime() && currentDayOffset === 0) {
                            scheduledDate.setDate(scheduledDate.getDate() + 1);
                        }
                        
                        // Apply the currentDayOffset for bosses that span across midnight within the list.
                        // This logic should be independent of the "today vs tomorrow" for an individual boss.
                        if (bossTimeInMinutes < lastBossTimeInMinutes) {
                            currentDayOffset++;
                        }
                        lastBossTimeInMinutes = bossTimeInMinutes;

                        if (currentDayOffset > 0) {
                            scheduledDate.setDate(scheduledDate.getDate() + currentDayOffset);
                        }

                        // Finally, filter out bosses whose scheduledDate is truly in the past.
                        if (scheduledDate.getTime() <= now.getTime()) {
                            removedPastBossCount++;
                            return; // Skip this boss
                        }

                        newBossSchedule.push({
                            time: parts[0], // Keep original HH:MM string for textarea display
                            name: parts[1],
                            scheduledDate: scheduledDate, // Store full Date object
                            alerted_5min: false,
                            alerted_1min: false,
                            alerted_0min: false,
                        });
                    }
                });
            
            bossSchedule = newBossSchedule; // Update the global bossSchedule

            // Sort bossSchedule by scheduledDate to ensure nextBossDisplay is accurate
            bossSchedule.sort((a, b) => a.scheduledDate.getTime() - b.scheduledDate.getTime());

            log(`${bossSchedule.length}ê°œì˜ ë³´ìŠ¤ ì¼ì •ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
            if (removedPastBossCount > 0) {
                log(`${removedPastBossCount}ê°œì˜ ì§€ë‚œ ë³´ìŠ¤ ì¼ì •ì„ ëª©ë¡ì—ì„œ ì œê±°í–ˆìŠµë‹ˆë‹¤.`, true);
            }
            updateBossListTextarea(); // Always update textarea after parsing and filtering
        }

        // --- 5.1. ë³´ìŠ¤ ëª©ë¡ í…ìŠ¤íŠ¸ ì˜ì—­ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        // bossSchedule ë°°ì—´ì˜ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ ì˜ì—­ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        function updateBossListTextarea() {
            bossListInput.value = bossSchedule
                .map(boss => `${boss.time} ${boss.name}`)
                .join('\n');

            // ë‹¤ìŒ ë³´ìŠ¤ í‘œì‹œ ì—…ë°ì´íŠ¸
            if (bossSchedule.length > 0) {
                const nextBoss = bossSchedule[0]; // bossScheduleì€ ì´ë¯¸ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
                nextBossDisplay.textContent = `ë‹¤ìŒ ë³´ìŠ¤: ${nextBoss.time} ${nextBoss.name}`;
            } else {
                nextBossDisplay.textContent = 'ë‹¤ìŒ ë³´ìŠ¤ ì—†ìŒ';
            }
        }


        // --- 5.2. ê³ ì • ì•Œë¦¼ ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜ ---
        function renderFixedAlarms(targetDiv) { // ì¸ìë¡œ targetDivë¥¼ ë°›ë„ë¡ ìˆ˜ì •
            targetDiv.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

            fixedBossSchedule.forEach((boss, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'fixed-alarm-item';
                itemDiv.id = `fixed-alarm-item-${index}`; // ê°œë³„ í•­ëª© ID

                const bossInfoSpan = document.createElement('span');
                bossInfoSpan.textContent = `${boss.time} ${boss.name}`;
                itemDiv.appendChild(bossInfoSpan);

                const switchLabel = document.createElement('label');
                switchLabel.className = 'switch';
                const switchInput = document.createElement('input');
                switchInput.type = 'checkbox';
                switchInput.id = `fixedAlarmToggle-${index}`;
                switchInput.checked = fixedAlarmStates.individual[index]; // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ìƒíƒœ ë°˜ì˜
                switchInput.addEventListener('change', (event) => {
                    fixedAlarmStates.individual[index] = event.target.checked;
                    saveFixedAlarmStates();
                    updateFixedAlarmVisuals(); // ë¹„ì£¼ì–¼ ì—…ë°ì´íŠ¸
                });
                const sliderSpan = document.createElement('span');
                sliderSpan.className = 'slider round';

                switchLabel.appendChild(switchInput);
                switchLabel.appendChild(sliderSpan);
                itemDiv.appendChild(switchLabel);

                targetDiv.appendChild(itemDiv);
            });
            updateFixedAlarmVisuals(); // ì´ˆê¸° ë¹„ì£¼ì–¼ ì—…ë°ì´íŠ¸
        }

        // --- 5.3. ê³ ì • ì•Œë¦¼ ë¹„ì£¼ì–¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (faded íš¨ê³¼) ---
        function updateFixedAlarmVisuals() {
            const fixedAlarmListDivElement = document.getElementById('fixedAlarmList'); // Re-get the element
            if (!fixedAlarmListDivElement) return; // Guard against null if element not found

            const fixedAlarmItems = fixedAlarmListDivElement.querySelectorAll('.fixed-alarm-item');
            if (!fixedAlarmStates.global) {
                fixedAlarmItems.forEach(item => item.classList.add('faded'));
            } else {
                fixedAlarmItems.forEach(item => item.classList.remove('faded'));
            }
        }

        // --- 6. ì•Œë¦¼ ì²´í¬ í•µì‹¬ í•¨ìˆ˜ ---
        // 1ì´ˆì— í•œ ë²ˆì”© ì‹¤í–‰ë˜ë©´ì„œ í˜„ì¬ ì‹œê°„ì´ ì•ŒëŒì„ ìš¸ë¦´ ì‹œê°„ì¸ì§€ ì²´í¬í•©ë‹ˆë‹¤.
        function checkAlarms() {
            const now = new Date();
            // Truncate milliseconds for precise comparison
            now.setMilliseconds(0); 
            now.setSeconds(0); // Also set seconds to 0 for consistency with scheduledDate

            const currentTimeString = now.toTimeString().substring(0, 5); 

            const fiveMinLater = new Date(now.getTime() + 5 * 60 * 1000);
            fiveMinLater.setMilliseconds(0);
            fiveMinLater.setSeconds(0);

            const oneMinLater = new Date(now.getTime() + 1 * 60 * 1000);
            oneMinLater.setMilliseconds(0);
            oneMinLater.setSeconds(0);

            // ... (reset logic for midnight)

            let bossesToRemove = [];
            
            // --- ì¼ë°˜ ë³´ìŠ¤ ì•Œë¦¼ ì²´í¬ ---
            for (let i = 0; i < bossSchedule.length; i++) {
                const boss = bossSchedule[i];
                const bossScheduledTime = boss.scheduledDate.getTime();

                // --- 5ë¶„ ì „ ì•Œë¦¼ ì²´í¬ ---
                if (bossScheduledTime === fiveMinLater.getTime() && !boss.alerted_5min) {
                    boss.alerted_5min = true;
                    const msg = `5ë¶„ ì „, ${boss.name}`;
                    log(msg, true);
                    speak(msg);
                }

                // --- 1ë¶„ ì „ ì•Œë¦¼ ì²´í¬ ---
                if (bossScheduledTime === oneMinLater.getTime() && !boss.alerted_1min) {
                    boss.alerted_1min = true;
                    const msg = `1ë¶„ ì „, ${boss.name}`;
                    log(msg, true);
                    speak(msg);
                }

                // --- ì •ê° ì•Œë¦¼ ì²´í¬ ---
                if (bossScheduledTime === now.getTime() && !boss.alerted_0min) {
                    boss.alerted_0min = true;
                    const msg = `${boss.name} ì   ì…ë‹ˆë‹¤.`;
                    log(msg, true);
                    speak(msg);
                    bossesToRemove.push(i);
                }
            }

            // ì•Œë¦¼ì´ ë°œìƒí•œ ì¼ë°˜ ë³´ìŠ¤ë¥¼ bossScheduleì—ì„œ ì œê±° (ë’¤ì—ì„œë¶€í„° ì œê±°í•˜ì—¬ ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€)
            for (let i = bossesToRemove.length - 1; i >= 0; i--) {
                bossSchedule.splice(bossesToRemove[i], 1);
            }

            // --- ê³ ì • ì•Œë¦¼ ë³´ìŠ¤ ì²´í¬ ---
            if (fixedAlarmStates.global) { // ì „ì—­ ê³ ì • ì•Œë¦¼ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì²´í¬
                fixedBossSchedule.forEach((boss, index) => {
                    if (fixedAlarmStates.individual[index]) { // ê°œë³„ ê³ ì • ì•Œë¦¼ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì²´í¬
                        const [bossHour, bossMinute] = boss.time.split(':').map(Number);
                        
                        // ê³ ì • ì•Œë¦¼ì€ ë§¤ì¼ ë°˜ë³µë˜ë¯€ë¡œ, í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ scheduledDateë¥¼ ê³„ì‚°
                        const fixedScheduledDate = new Date(now);
                        fixedScheduledDate.setHours(bossHour, bossMinute, 0, 0);

                        // ë§Œì•½ ì´ë¯¸ ì§€ë‚œ ì‹œê°„ì´ë¼ë©´ ë‹¤ìŒ ë‚ ë¡œ ì„¤ì • (ìì • ë„˜ê¹€ ì²˜ë¦¬)
                        if (fixedScheduledDate.getTime() <= now.getTime() - 1000) { // 1ì´ˆ ì—¬ìœ 
                            fixedScheduledDate.setDate(fixedScheduledDate.getDate() + 1);
                        }

                        const fixedBossScheduledTime = fixedScheduledDate.getTime();

                        // --- 5ë¶„ ì „ ì•Œë¦¼ ì²´í¬ ---
                        if (Math.abs(fixedBossScheduledTime - fiveMinLater.getTime()) < 1000 && !boss.alerted_5min) {
                            boss.alerted_5min = true;
                            const msg = `5ë¶„ ì „, ${boss.name}`;
                            log(msg, true);
                            speak(msg);
                        }

                        // --- 1ë¶„ ì „ ì•Œë¦¼ ì²´í¬ ---
                        if (Math.abs(fixedBossScheduledTime - oneMinLater.getTime()) < 1000 && !boss.alerted_1min) {
                            boss.alerted_1min = true;
                            const msg = `1ë¶„ ì „, ${boss.name}`;
                            log(msg, true);
                            speak(msg);
                        }

                        // --- ì •ê° ì•Œë¦¼ ì²´í¬ ---
                        if (Math.abs(fixedBossScheduledTime - now.getTime()) < 1000 && !boss.alerted_0min) {
                            boss.alerted_0min = true;
                            const msg = `${boss.name} ì   ì…ë‹ˆë‹¤.`;
                            log(msg, true);
                            speak(msg);
                            // ê³ ì • ì•Œë¦¼ì€ ëª©ë¡ì—ì„œ ì œê±°í•˜ì§€ ì•ŠìŒ
                        }
                    }
                });
            }

            // ë§¤ì´ˆ ë‹¤ìŒ ë³´ìŠ¤ í‘œì‹œë¥¼ ì—…ë°ì´íŠ¸
            updateBossListTextarea();
        }


        // --- 7. 'ì•Œë¦¼ ì‹œì‘/ì¤‘ì§€' í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        startButton.addEventListener('click', () => {
            // ì•Œë¦¼ ì‹¤í–‰ ìƒíƒœë¥¼ ë°˜ëŒ€ë¡œ ë³€ê²½ (true -> false, false -> true)
            isAlarmRunning = !isAlarmRunning; 

            if (isAlarmRunning) {
                // --- ì•Œë¦¼ì„ ì¼œëŠ” ê²½ìš° ---
                startButton.textContent = "ì•Œë¦¼ ì¤‘ì§€ (ì‹¤í–‰ ì¤‘)";
                startButton.classList.add('running'); // ë¹¨ê°„ìƒ‰ ìŠ¤íƒ€ì¼ ì ìš©
                
                if (alertTimerId) clearInterval(alertTimerId); // ë§Œì•½ì˜ íƒ€ì´ë¨¸ ì œê±°

                // (ì¤‘ìš”) í…ìŠ¤íŠ¸ ìƒìì˜ ìµœì‹  ë‚´ìš©ìœ¼ë¡œ ëª©ë¡ì„ ë‹¤ì‹œ íŒŒì‹±
                parseBossList(); 
                const fixedAlarmListDivElement = document.getElementById('fixedAlarmList');
                renderFixedAlarms(fixedAlarmListDivElement); // ê³ ì • ì•Œë¦¼ ëª©ë¡ë„ ë‹¤ì‹œ ë Œë”ë§

                log("ì•Œë¦¼ ì‹œìŠ¤í…œì„ ì‹œì‘í•©ë‹ˆë‹¤.");
                speak("ë³´ìŠ¤ ì•Œë¦¬ë¯¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
                
                // 1ì´ˆë§ˆë‹¤ checkAlarms í•¨ìˆ˜ ì‹¤í–‰ ì‹œì‘
                alertTimerId = setInterval(checkAlarms, 1000);

            } else {
                // --- ì•Œë¦¼ì„ ë„ëŠ” ê²½ìš° ---
                startButton.textContent = "ì•Œë¦¼ ì‹œì‘";
                startButton.classList.remove('running'); // ê¸°ë³¸ ìŠ¤íƒ€ì¼ë¡œ ë³µê·€
                
                // 1ì´ˆë§ˆë‹¤ ì‹¤í–‰ë˜ë˜ íƒ€ì´ë¨¸ë¥¼ ì¤‘ì§€
                if (alertTimerId) {
                    clearInterval(alertTimerId);
                    alertTimerId = null;
                }
                
                log("ì•Œë¦¼ ì‹œìŠ¤í…œì„ ì¤‘ì§€í•©ë‹ˆë‹¤.");
                speak("ì•Œë¦¬ë¯¸ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤.");
            }
        });


        // --- 7.1. ê³ ì • ì•Œë¦¼ ì „ì²´ ON/OFF í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        globalFixedAlarmToggle.addEventListener('change', (event) => {
            fixedAlarmStates.global = event.target.checked;
            saveFixedAlarmStates();
            updateFixedAlarmVisuals(); // ë¹„ì£¼ì–¼ ì—…ë°ì´íŠ¸
        });

        // --- 7.2. ì•Œë¦¼ ë¡œê·¸ ê°€ì‹œì„± í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        logVisibilityToggle.addEventListener('change', (event) => {
            logVisibilityState = event.target.checked;
            saveLogVisibilityState();
            if (logVisibilityState) {
                logContainer.classList.remove('hidden');
            } else {
                logContainer.classList.add('hidden');
            }
        });

        // --- 8. URL ë‹¨ì¶• í•¨ìˆ˜ (TinyURL API) ---
        // API í˜¸ì¶œì„ ê¸°ë‹¤ë ¤ì•¼ í•˜ë¯€ë¡œ async/await ì‚¬ìš©
        async function getShortUrl(longUrl) {
            // TinyURLì˜ ë¬´ë£Œ API ì£¼ì†Œ
            const apiUrl = `https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`;
            
            try {
                // fetch: APIì— ë„¤íŠ¸ì›Œí¬ ìš”ì²­(GET)ì„ ë³´ëƒ„
                const response = await fetch(apiUrl);
                
                if (response.ok) { // ì‘ë‹µì´ ì„±ê³µ(200)ì´ë©´
                    const shortUrl = await response.text(); // ì‘ë‹µ ë‚´ìš©ì„ í…ìŠ¤íŠ¸ë¡œ ë°›ìŒ (ì´ê²Œ ë‹¨ì¶• URL)
                    return shortUrl;
                } else {
                    // ì„œë²„ê°€ 404, 500 ë“± ì—ëŸ¬ë¥¼ ë°˜í™˜í•œ ê²½ìš°
                    throw new Error('API ì‘ë‹µ ì‹¤íŒ¨');
                }
            } catch (error) {
                // ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜ ë˜ëŠ” ìœ„ì—ì„œ ë°œìƒì‹œí‚¨ ì—ëŸ¬
                console.error("URL ë‹¨ì¶• ì‹¤íŒ¨:", error);
                return null; // ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
            }
        }


        // --- 9. 'ê³µìœ  ë§í¬ ìƒì„±' ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        // APIë¥¼ í˜¸ì¶œí•´ì•¼ í•˜ë¯€ë¡œ async í•¨ìˆ˜ë¡œ ì •ì˜
        shareButton.addEventListener('click', async () => {
            
            // 1. ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
            shareButton.disabled = true;
            shareButton.textContent = "ë‹¨ì¶• URL ìƒì„± ì¤‘...";
            shareLinkInput.value = "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...";

            // 2. ì›ë³¸ ê¸´ URL ìƒì„±
            const currentData = bossListInput.value;
            const encodedData = encodeURIComponent(currentData); // ë°ì´í„°ë¥¼ URLì— ì“¸ ìˆ˜ ìˆê²Œ ì¸ì½”ë”©
            const baseUrl = window.location.href.split('?')[0]; // í˜„ì¬ ì£¼ì†Œì—ì„œ ? ì•ë¶€ë¶„ë§Œ ê°€ì ¸ì˜´
            const longUrl = `${baseUrl}?data=${encodedData}`;

            // 3. URL ë‹¨ì¶• ì‹œë„ (getShortUrl í•¨ìˆ˜ê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼)
            const shortUrl = await getShortUrl(longUrl);

            if (shortUrl) {
                // 4-1. ë‹¨ì¶• ì„±ê³µ ì‹œ
                shareLinkInput.value = shortUrl;
                log("ë‹¨ì¶• URLì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. 'ë³µì‚¬' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.", true);
            } else {
                // 4-2. ë‹¨ì¶• ì‹¤íŒ¨ ì‹œ (ê¸´ URLì„ ëŒ€ì‹  ì‚¬ìš©)
                shareLinkInput.value = longUrl;
                log("URL ë‹¨ì¶• ì‹¤íŒ¨. ëŒ€ì‹  ì›ë³¸ URLì„ ìƒì„±í•©ë‹ˆë‹¤.", true);
            }

            // 5. ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            shareButton.disabled = false;
            shareButton.textContent = "ê³µìœ  ë§í¬ ìƒì„± (Short URL)";
        });


        // --- 10. 'ë³µì‚¬' ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        copyButton.addEventListener('click', () => {
            const urlToCopy = shareLinkInput.value;
            
            // ë³µì‚¬í•  ë‚´ìš©ì´ ìˆëŠ”ì§€, ì´ˆê¸° í…ìŠ¤íŠ¸ê°€ ì•„ë‹Œì§€ í™•ì¸
            if (urlToCopy && urlToCopy !== "ëª©ë¡ ìˆ˜ì • í›„ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”" && urlToCopy !== "ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...") {
                
                // navigator.clipboard.writeText : í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ë¥¼ ì“°ëŠ” í‘œì¤€ API
                navigator.clipboard.writeText(urlToCopy).then(() => {
                    // ë³µì‚¬ ì„±ê³µ ì‹œ
                    log("ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.", true);
                    
                    // ì‚¬ìš©ì í”¼ë“œë°±: ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ì ì‹œ ë³€ê²½
                    const originalText = copyButton.textContent;
                    copyButton.textContent = 'ë³µì‚¬ë¨!';
                    setTimeout(() => {
                        copyButton.textContent = originalText;
                    }, 1500); // 1.5ì´ˆ í›„ì— ì›ë˜ í…ìŠ¤íŠ¸ë¡œ ë³µê·€
                
                }).catch(err => {
                    // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ (ì˜ˆ: http í™˜ê²½, ì˜¤ë˜ëœ ë¸Œë¼ìš°ì € ë“±)
                    log("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.", true);
                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                });
            } else {
                log("ë³µì‚¬í•  ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë§í¬ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.", false);
            }
        });


        // --- 11. í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ ---
        window.addEventListener('load', () => {
            // í˜„ì¬ í˜ì´ì§€ì˜ URL íŒŒë¼ë¯¸í„°(ë¬¼ìŒí‘œ ë’¤)ë¥¼ ê°€ì ¸ì˜´
            const params = new URLSearchParams(window.location.search);
            
            // 'data'ë¼ëŠ” ì´ë¦„ì˜ íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (params.has('data')) {
                // 'data' ê°’ì„ ê°€ì ¸ì™€ì„œ 'ì••ì¶• í•´ì œ' (ë””ì½”ë”©)
                const decodedData = decodeURIComponent(params.get('data'));
                
                // í…ìŠ¤íŠ¸ ìƒì(textarea)ì˜ ë‚´ìš©ì„ URLì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ ì±„ì›€
                bossListInput.value = decodedData;
                
                log("URLì—ì„œ ë³´ìŠ¤ ëª©ë¡ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
            } else {
                // URLì— dataê°€ ì—†ìœ¼ë©´
                log("ê¸°ë³¸ ë³´ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (URL ë°ì´í„° ì—†ìŒ)");
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë³´ìŠ¤ ëª©ë¡ì„ íŒŒì‹±í•˜ê³  ì§€ë‚œ ë³´ìŠ¤ë¥¼ ì œê±°
            parseBossList();

            // ê³ ì • ì•Œë¦¼ ìƒíƒœ ë¡œë“œ ë° ë Œë”ë§
            loadFixedAlarmStates();
            globalFixedAlarmToggle.checked = fixedAlarmStates.global; // ì „ì—­ ìŠ¤ìœ„ì¹˜ ìƒíƒœ ë°˜ì˜
            
            // fixedAlarmListDivë¥¼ ì—¬ê¸°ì„œ ë‹¤ì‹œ ê°€ì ¸ì™€ì„œ renderFixedAlarmsì— ì „ë‹¬
            const fixedAlarmListDivElement = document.getElementById('fixedAlarmList'); // Renamed to avoid conflict
            renderFixedAlarms(fixedAlarmListDivElement);
            // ì•Œë¦¼ ë¡œê·¸ ê°€ì‹œì„± ìƒíƒœ ë¡œë“œ ë° ì ìš©
            loadLogVisibilityState();
            logVisibilityToggle.checked = logVisibilityState; // ìŠ¤ìœ„ì¹˜ ìƒíƒœ ë°˜ì˜
            if (logVisibilityState) {
                logContainer.classList.remove('hidden');
            } else {
                logContainer.classList.add('hidden');
            }
        });

    </script>
    <footer>
        <p>Created by: bohe</p>
    </footer>
</body>
</html>